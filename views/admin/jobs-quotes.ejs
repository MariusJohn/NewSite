<!--views/admin/jobs-quotes.ejs-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Job Quotes - Admin Dashboard</title>
    <link rel="stylesheet" href="/css/admin-dashboard.css">
    <link rel="stylesheet" href="/css/reset.css">

        <link href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" rel="stylesheet">
         <link rel="preconnect" href="https://fonts.googleapis.com">
         <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
          <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-dashboard-container">
      <div class="sidebar" id="sidebar">
        <button id="toggleSidebar" class="sidebar-toggle">‚ò∞</button>
        <a href="/." ><img src="/img/logo-true.svg" alt="My Car Quote Logo"></a>
        <h2>Admin Panel</h2>
        <ul class="menu">
          <li><a href="/jobs<%= ADMIN_BASE %>?filter=total">Total Jobs (<%= totalCount %>)</a></li>
          <li><a href="/jobs<%= ADMIN_BASE %>?filter=live">Live Jobs (<%= liveCount %>)</a></li>
          <li><a href="/jobs<%= ADMIN_BASE %>?filter=approved">Approved Jobs (<%= approvedCount %>)</a></li>
          <li><a href="/jobs<%= ADMIN_BASE %>?filter=rejected">Rejected Jobs (<%= rejectedCount %>)</a></li>
          <li><a href="/jobs<%= ADMIN_BASE %>?filter=archived">Archived Jobs (<%= archivedCount %>)</a></li>
          <li><a href="/jobs<%= ADMIN_BASE %>?filter=deleted">Deleted Jobs (<%= deletedCount %>)</a></li>
          <li><a href="/jobs<%= ADMIN_BASE %>/quotes" class="active">Jobs with Quotes</a></li>
          <li><a href="/jobs<%= ADMIN_BASE %>/bodyshops">Bodyshops</a></li>
          <li>
            <form action="<%= ADMIN_BASE %>/logout" method="POST">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit" class="logout-btn">Logout</button>
            </form>
          </li>
        </ul>
      </div>

      <div class="main-content">
        <h1>Submitted Jobs with Quotes</h1>

        <% if (jobs.length === 0) { %>
            <p>No jobs with quotes available at the moment.</p>
        <% } else { %>

          <div style="text-align: right; margin-bottom: 1rem;">
            <a href="/jobs<%= ADMIN_BASE %>/quotes/export-csv" class="btn btn-export">üì• Export CSV</a>
            <form action="<%= ADMIN_BASE %>/scheduler/manual-run" method="POST" style="display:inline;">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit" class="btn btn-scheduler">üïí Run Scheduler</button>
            </form>
            
          </div>
                    
           

            <table class="quotes-table">
              <thead>
                <tr>
                  <th>Job ID</th>
                  <th>Customer Details</th>
                  <th>Bodyshop</th>
                  <th>Quote</th>
                  <th>Status</th>
                  <th>Days Pending</th>
                  <th>Date Uploaded</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% jobs.forEach(job => { %>
                <tr class="job-summary" data-job-id="<%= job.id %>">
                  <td><%= job.id %></td>
                  <td>
                    <div class="customer-info-block">
                      <strong>Name:</strong> <%= job.customerName %><br>
                      <strong>Email:</strong> <%= job.customerEmail %><br>
                      <strong>Phone:</strong> <%= job.customerPhone %><br>
                      <strong>Location:</strong> <%= job.location %><br>

                      <strong>Uploaded:</strong>
                      <%= new Date(job.createdAt).toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false,
                        timeZone: 'Europe/London'
                      }) %><br>

                      <%
                        const createdAt = new Date(job.createdAt);
                        const now = new Date();
                        const diffMs = now - createdAt;
                        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                        let timeClass = '';
                        if (diffHours < 24) {
                          timeClass = 'elapsed-ok';
                        } else if (diffHours < 48) {
                          timeClass = 'elapsed-warning';
                        } else {
                          timeClass = 'elapsed-critical';
                        }
                      %>
                      <small class="<%= timeClass %>">(Elapsed: <%= diffHours %>h <%= diffMinutes %>m)</small>
                    </div>
                  </td>

                  <td>
                    <% if (job.quotes && job.quotes.length > 0) { %>
                      <% const selectedQuote = job.quotes.find(q => q.bodyshopId === job.selectedBodyshopId); %>
                      <%= selectedQuote ? selectedQuote.bodyshop?.name : '‚Äî' %>
                    <% } else { %>
                      ‚Äî
                    <% } %>
                  </td>
                  <td><%= job.quotes?.length || 0 %></td>
                  <td>
                    <% if (job.paid && job.selectedBodyshopId) { %>
                      <span class="status-badge processed">Paid_BS Selected</span>
                    <% } else if (job.paid && !job.selectedBodyshopId) { %>
                      <span class="status-badge paid">Paid_BS NOT Selected</span>
                    <% } else if (!job.paid && (job.quotes?.length || 0) >= 1 && job.daysPending >= 2) { %>
                      <span class="status-badge danger">Unpaid (Overdue)</span>
                    <% } else if (!job.paid && (job.quotes?.length || 0) >= 1) { %>
                      <span class="status-badge unpaid">Unpaid</span>
                    <% } else { %>
                      <span class="status-badge"><%= job.status %></span>
                    <% } %>
                  </td>
                  <td><%= typeof job.daysPending !== 'undefined' ? job.daysPending : '‚Äî' %></td>

     
                  <td><%= new Date(job.createdAt).toLocaleDateString() %></td>


                      <td class="action-cell">
                        <div class="action-buttons">
                          <!-- Toggle Quotes -->
                          <a href="#" class="toggle-quotes btn btn-view" data-job-id="<%= job.id %>" title="View Quotes"></a>

                      
                            <!-- Request Payment -->
                        
                           <% 
                              const jobCreated = new Date(job.createdAt); 
                             %>


                            <% if (job.paid) { %>
                              <span class="btn btn-disabled">‚úÖ Paid</span>
                            <% } else if (job.status === 'archived') { %>
                              <span class="btn btn-disabled">üìÅ Archived</span>
                            <% } else if (diffHours >= 48) { %>
                              <form action="/jobs<%= ADMIN_BASE %>/<%= job.id %>/resend-payment" method="POST" style="display:inline;">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <button type="submit" class="btn btn-warning">üí≥ Request Payment</button>
                              </form>
                            <% } else { %>
                              <span class="btn btn-disabled">‚è≥ Visible after 48h</span>
                            <% } %>

                              
                          <!-- Archive -->
                            <% if (job.paid && job.selectedBodyshopId && job.status !== 'archived') { %>
                              <form action="/jobs<%= ADMIN_BASE %>/<%= job.id %>/archive" method="POST" style="display:inline;">
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <button type="submit" class="btn btn-archive">üóÇ Archive</button>
                              </form>
                            <% } %>


                          <!-- Delete -->
                          <% if (!job.paid && job.quotes?.length > 0 && job.daysPending >= 2) { %>
                            <form action="/jobs<%= ADMIN_BASE %>/<%= job.id %>/soft-delete" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure?');">
                              <button type="submit" class="btn btn-danger">üóë Delete</button>
                            </form>
                          <% } %>

                        </div>
                      </td>


                  
                </tr>
                <tr class="quote-details" id="quotes-<%= job.id %>" style="display:none;">
                  <td colspan="9">
                    <table class="inner-quotes-table">
                      <thead>
                        <tr>
                          <th>Bodyshop</th><th>Price</th><th>Notes</th><th>Date</th><th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% job.quotes.forEach(quote => { %>
                        <tr class="<%= job.selectedBodyshopId === quote.bodyshopId ? 'highlight' : '' %>">
                          <td><%= quote.bodyshop?.name || 'Unknown' %></td>
                          <td>¬£<%= quote.price.toFixed(2) %></td>
                          <td><%= quote.notes || 'N/A' %></td>
                          <td><%= new Date(quote.createdAt).toLocaleDateString() %></td>
                          <td>
                            <% if (job.selectedBodyshopId === quote.bodyshopId) { %>
                              selected
                            <% } else { %>
                              submitted
                            <% } %>
                          </td>
                        </tr>
                        <% }) %>
                      </tbody>
                    </table>

                            <%
                              let parsedImages = [];

                              if (Array.isArray(job.images)) {
                                parsedImages = job.images;
                              } else if (typeof job.images === 'string') {
                                try {
                                  parsedImages = job.images
                                    .replace(/[{}"]/g, '')
                                    .split(',')
                                    .map(i => i.trim())
                                    .filter(Boolean);
                                } catch (err) {
                                  parsedImages = [];
                                }
                              }
                            %>

                            <% if (parsedImages.length > 0) { %>
                              <div class="image-gallery">
                                <% parsedImages.forEach((img, idx) => { %>
                                  <a href="<%= img %>" 
                                    class="glightbox"
                                    data-gallery="job-<%= job.id %>"
                                    data-title="Job Image <%= idx + 1 %>">
                                    <img src="<%= img %>" alt="Job Image" class="job-image-preview" />
                                  </a>
                                <% }) %>
                              </div>
                            <% } else { %>
                              <span class="badge badge-warning">No images</span>
                            <% } %>

                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
        <% } %>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
    <script>
      document.querySelectorAll(".job-summary").forEach(row => {
        row.addEventListener("click", () => {
          const jobId = row.dataset.jobId;
          const quotesRow = document.getElementById("quotes-" + jobId);
          const isVisible = quotesRow.style.display === "table-row";
          quotesRow.style.display = isVisible ? "none" : "table-row";

          if (!isVisible) {
            GLightbox({ selector: `.glightbox${jobId}` });
          }
        });
      });
    </script>
</body>
</html>
