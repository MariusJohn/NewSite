<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>Job Quotes - Admin Dashboard</title>
    <link rel="stylesheet" href="/css/admin-dashboard.css">
    <link rel="stylesheet" href="/css/reset.css">
    <link href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" rel="stylesheet">
</head>
<body>
    <div class="admin-dashboard-container">
        <div class="sidebar">
            <a href="/."><img src="/img/logo.png" alt="MC Quote Logo"></a>
            <h2>Admin Panel</h2>
            <ul class="menu">
                <li><a href="/jobs/admin?filter=total">Total Jobs (<%= totalCount %>)</a></li>
                <li><a href="/jobs/admin?filter=live">Live Jobs (<%= liveCount %>)</a></li>
                <li><a href="/jobs/admin?filter=approved">Approved Jobs (<%= approvedCount %>)</a></li>
                <li><a href="/jobs/admin?filter=rejected">Rejected Jobs (<%= rejectedCount %>)</a></li>
                <li><a href="/jobs/admin?filter=archived">Archived Jobs (<%= archivedCount %>)</a></li>
                <li><a href="/jobs/admin?filter=deleted">Deleted Jobs (<%= deletedCount %>)</a></li>
                <li><a href="/jobs/admin/quotes" class="active">Jobs with Quotes</a></li>
                <li><a href="/jobs/admin/bodyshops">Bodyshops</a></li>
            </ul>
        </div>

        <div class="main-content">
            <h1>Submitted Jobs with Quotes</h1>

            <% if (jobs.length === 0) { %>
                <p>No jobs with quotes available at the moment.</p>
            <% } else { %>
                <table class="quotes-table">
                    <thead>
                        <tr>
                            <th>Job ID</th>
                            <th>Customer Details</th>
                            <th>Bodyshop</th>
                            <th>Quote</th>
                            <th>Notes</th>
                            <th>Quote Date</th>
                            <th>Status</th>
                            <th>Days Pending</th>
                            <th>Quote Status</th>
                            <th>Last Action</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% jobs.forEach(job => { %>
                            <tr class="job-summary">
                              <td><%= job.id %></td>
                              <td><strong><%= job.customerName %></strong><br><%= job.customerEmail %><br><%= job.customerPhone %></td>
                              <td colspan="8">
                                <strong><%= job.location %></strong><br>
                                <% if (job.paid && job.selectedBodyshopId) { %>
                                  <%= job.paid ? 'Paid' : 'Unpaid' %>
                                  <% if (job.selectedBodyshopId) { %> & Allocated <% } %> | Pending: <%= job.daysPending %> days

                                <% } else if (job.quotes && job.quotes.length > 0) { %>
                                  <%= job.quotes.length %> Quote<%= job.quotes.length > 1 ? 's' : '' %> Received
                                <% } else { %>
                                  No Quotes Yet
                                <% } %> | Pending: <%= job.daysPending %> days
                                <br>
                                <button class="toggle-quotes" data-job-id="<%= job.id %>">Toggle Quotes</button>
                                <a href="/admin/jobs/<%= job.id %>/remind" class="btn btn-remind">Remind</a>
                              </td>
                            </tr>
                          
                            <tr class="quote-details" id="quotes-<%= job.id %>" style="display:none;">
                              <td colspan="11">
                                <table class="inner-quotes-table">
                                  <thead>
                                    <tr>
                                      <th>Bodyshop</th><th>Price</th><th>Notes</th><th>Date</th><th>Status</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    <% job.quotes.forEach(quote => { %>
                                      <tr class="<%= job.selectedBodyshopId === quote.bodyshopId ? 'highlight' : '' %>">

                                        <td><%= quote.bodyshop?.name || 'Unknown' %></td>
                                        <td>Â£<%= quote.price.toFixed(2) %></td>
                                        <td><%= quote.notes || 'N/A' %></td>
                                        <td><%= quote.createdAt.toLocaleDateString() %></td>
                                        <td>
                                          <% if (job.selectedBodyshopId === quote.bodyshopId) { %>
                                            selected
                                          <% } else { %>
                                            submitted
                                          <% } %>
                                        </td>
                                        
                                      </tr>
                                    <% }) %>
                                  </tbody>
                                </table>
                            
                                <% if (job.images && job.images.length) { %>
                                <div class="image-gallery">
                                  <% job.images.forEach((img, idx) => { %>
                                    <a href="<%= img %>" class="glightbox<%= job.id %>" data-gallery="job-<%= job.id %>">
                                      <img src="<%= img %>" alt="Job Image <%= idx + 1 %>" class="job-image-preview" />
                                    </a>
                                  <% }) %>
                                </div>
                                <% } %>
                              </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            <% } %>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
    <script>
      document.querySelectorAll('.toggle-quotes').forEach(btn => {
        btn.addEventListener('click', () => {
          const jobId = btn.dataset.jobId;
          const quotesRow = document.getElementById('quotes-' + jobId);
          const isVisible = quotesRow.style.display === 'table-row';
          quotesRow.style.display = isVisible ? 'none' : 'table-row';

          if (!isVisible) {
            GLightbox({ selector: `.glightbox${jobId}` });
          }
        });
      });
    </script>
</body>
</html>
