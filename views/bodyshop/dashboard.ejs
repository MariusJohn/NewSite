<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bodyshop Dashboard</title>
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/bodyshop-dashboard.css">
  <link href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" rel="stylesheet">
</head>
<body>
<div class="bodyshop-dashboard-container">
  


<!-- Sidebar -->
  <div class="sidebar">
    <div class="logo-wrapper">
     <img src="/img/logo-true.svg" alt="My Car Quote Logo">
    </div>
    
    <% if (subscriptionMessage) { %>
      <div style="background: #dff0d8; color: #3c763d; padding: 1rem; border-radius: 5px; margin: 1rem;">
        <%= subscriptionMessage %>
      </div>
    <% } %>
  

    <h2>Welcome, <%= bodyshopName %></h2>

    <ul class="menu">
      <li><a href="/bodyshop/dashboard?tab=available" class="<%= tab === 'available' ? 'active' : '' %>">Available Jobs</a></li>
      <li><a href="/bodyshop/dashboard?tab=quoted" class="<%= tab === 'quoted' ? 'active' : '' %>">Quoted Jobs</a></li>
      <li><a href="/bodyshop/dashboard?tab=selected" class="<%= tab === 'selected' ? 'active' : '' %>">Selected Jobs</a></li>
      <li><a href="/bodyshop/dashboard/unselected" class="<%= title === 'Unselected Jobs' ? 'active' : '' %>">Unselected Jobs</a></li>

     </ul>

    <form action="/bodyshop/update-radius" method="POST" class="radius-form">
      <label for="radius">Radius (mi):</label>
      <input type="number" name="radius" value="<%= bodyshop.radius || 10 %>" min="1" max="30">
      <button type="submit" class="btn radius-btn">Update</button>
    </form>

    <form action="/bodyshop/logout" method="GET">
      <button type="submit" class="btn logout-btn">Logout</button>
    </form>
  </div>

  <!-- Main Content -->
  <div class="main-content">

    <% if (tab === 'available') { %>
      <section class="dashboard-section">
        <h1>Available Jobs (<%= jobs.length %>)</h1>
        <% if (jobs.length === 0) { %>
          <p>No available jobs at the moment.</p>
        <% } else { %>
          <table class="jobs-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Location<br> Job Creation Date</th>
                <th>Distance</th>
                <th>Images</th>
                <th>Days</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% jobs.forEach((job, index) => { %>
                <tr>
                  <td><%= index + 1 %></td>
                  <td>
                    <%= job.location.toUpperCase().replace(/\s+/g, '').replace(/(.{3})$/, ' $1') %><br>
                    <%= new Date(job.createdAt).toLocaleDateString('en-GB', {
                      day: '2-digit', month: '2-digit', year: 'numeric',
                      hour: '2-digit', minute: '2-digit',
                      hour12: false,
                      timeZone: 'Europe/London'
                    }) %><br>
                    <small>(<%= Math.floor((Date.now() - new Date(job.createdAt)) / (1000 * 60 * 60 * 24)) %> days ago)</small>
                  </td>
                  <td><%= (job.distance / 1609.34).toFixed(2) %> mi</td>
                  <td>
                      <div class="image-preview-block">
                        <%
                          let parsedImages = [];

                          if (Array.isArray(job.images)) {
                            parsedImages = job.images;
                          } else if (typeof job.images === 'string') {
                            try {
                              parsedImages = job.images
                                .replace(/[{}"]/g, '')
                                .split(',')
                                .map(i => i.trim())
                                .filter(Boolean);
                            } catch (err) {
                              parsedImages = [];
                            }
                          }
                        %>

                        <% if (parsedImages.length > 0) { %>
                          <% parsedImages.forEach((img, idx) => { %>
                            <a href="<%= img %>" class="glightbox" data-gallery="job-<%= job.id %>">
                              <img src="<%= img %>" class="thumb-img" />
                            </a>
                          <% }) %>
                        <% } else { %>
                          <span class="badge badge-warning">No images</span>
                        <% } %>
                      </div>

                  </td>
                  <td>
                    <% const days = Math.floor((new Date() - new Date(job.createdAt)) / (1000 * 60 * 60 * 24)); %>
                    <span class="badge <%= days > 7 ? 'badge-danger' : days > 3 ? 'badge-warning' : 'badge-success' %>"><%= days %></span>
                  </td>
                  <td>
                    <form action="/bodyshop/quote/<%= job.id %>" method="POST">
                      <input type="number" name="price" placeholder="£" class="quote-input" required>

                      <textarea name="notes" placeholder="Add notes (optional)" class="quote-notes-input" rows="2"></textarea>
                      <button class="btn">Submit</button>
                    </form>
                    
                    
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </section>

    <% } else if (tab === 'quoted') { %>
      <section class="dashboard-section">
        <h1>Quoted Jobs (<%= quotedJobs.length %>)</h1>
        <% if (quotedJobs.length === 0) { %>
          <p>No submitted quotes yet.</p>
        <% } else { %>
          <table class="jobs-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Location<br> Job Creation Date</th>
                <th>Distance</th>
                <th>Images</th>
                <th>Quoted</th>
                <th>Your Quote</th>
              </tr>
            </thead>
            <tbody>
              <% quotedJobs.forEach((job, index) => { %>
                <tr class="<%= job.allocated ? 'allocated-row' : '' %>">
                  <td><%= index + 1 %></td>
                  <td>
                    <%= job.location.toUpperCase().replace(/\s+/g, '').replace(/(.{3})$/, ' $1') %><br>
                    <%= new Date(job.createdAt).toLocaleDateString('en-GB', {
                      day: '2-digit', month: '2-digit', year: 'numeric',
                      hour: '2-digit', minute: '2-digit',
                      hour12: false,
                      timeZone: 'Europe/London'
                    }) %>
                  </td>
                  <td><%= (job.distance / 1609.34).toFixed(2) %> mi</td>
                  <td>
                        <div class="image-preview-block">
                          <%
                            let parsedImages = [];

                            if (Array.isArray(job.images)) {
                              parsedImages = job.images;
                            } else if (typeof job.images === 'string') {
                              try {
                                parsedImages = job.images
                                  .replace(/[{}"]/g, '')
                                  .split(',')
                                  .map(i => i.trim())
                                  .filter(Boolean);
                              } catch (err) {
                                parsedImages = [];
                              }
                            }
                          %>

                          <% if (parsedImages.length > 0) { %>
                            <% parsedImages.forEach((img, idx) => { %>
                              <a href="<%= img %>" class="glightbox" data-gallery="job-<%= job.id %>">
                                <img src="<%= img %>" class="thumb-img" />
                              </a>
                            <% }) %>
                          <% } else { %>
                            <span class="badge badge-warning">No images</span>
                          <% } %>
                        </div>

                  </td>
                  <td>
                    <% const quotedDays = Math.floor((new Date() - new Date(job.quoteDate)) / (1000 * 60 * 60 * 24)); %>
                    <span class="badge badge-info"><%= quotedDays %> days</span>
                  </td>
                  <td>
                    £<%= job.quoteAmount %>
                    <% if (job.allocated) { %>
                      <span class="badge badge-allocated">Allocated</span>
                    <% } %>
                    <% if (job.quoteNotes) { %>
                      <div class="quote-notes-display">
                        <strong>Notes:</strong> <%= job.quoteNotes %>
                      </div>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
        </table>
        <% } %>
        </section>


      <% } else if (tab === 'selected') { %>  
        <section class="dashboard-section">
        <h1>Selected Jobs (<%= selectedJobs.length %>)</h1>
        <% if (selectedJobs.length === 0) { %>
          <p>No jobs where the customer selected you yet.</p>
        <% } else { %>
          <table class="jobs-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Location</th>
                <th>Customer</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Images</th>
              </tr>
            </thead>
            <tbody>
              <% selectedJobs.forEach((job, index) => { %>
                <tr>
                  <td><%= index + 1 %></td>
                  <td><%= job.location %></td>
                  <td><%= job.customerName %></td>
                  <td><%= job.customerPhone %></td>
                  <td><%= job.customerEmail %></td>
                  <td>
                      <div class="image-preview-block">
                        <%
                          let parsedImages = [];

                          if (Array.isArray(job.images)) {
                            parsedImages = job.images;
                          } else if (typeof job.images === 'string') {
                            try {
                              parsedImages = job.images
                                .replace(/[{}"]/g, '')
                                .split(',')
                                .map(i => i.trim())
                                .filter(Boolean);
                            } catch (err) {
                              parsedImages = [];
                            }
                          }
                        %>

                        <% if (parsedImages.length > 0) { %>
                          <% parsedImages.forEach((img, idx) => { %>
                            <a href="<%= img %>" class="glightbox" data-gallery="job-<%= job.id %>">
                              <img src="<%= img %>" class="thumb-img" />
                            </a>
                          <% }) %>
                        <% } else { %>
                          <span class="badge badge-warning">No images</span>
                        <% } %>
                      </div>

                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </section>
    

      <% } else if (tab === 'unselected') { %>  
        <section class="dashboard-section">
          <h1>Unselected Jobs (<%= unselectedJobs.length %>)</h1>
          <% if (unselectedJobs.length === 0) { %>
            <p>No unselected quotes to display.</p>
          <% } else { %>
            <% unselectedJobs.forEach((job, index) => { %>
              <div class="job-summary collapsible">
                <div class="summary-header">
                  <strong>#<%= job.jobId %></strong> — <em>Your Quote: £<%= job.allQuotes.find(q => q.isMine)?.price %></em> —
                  <small><%= new Date(job.quoteDate).toLocaleDateString('en-GB', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit',
                    hour12: false, timeZone: 'Europe/London'
                  }) %></small>
                </div>
                <div class="summary-content" style="display: none;">
                  <table class="jobs-table">
                    <thead>
                      <tr>
                        <th>Bodyshop</th>
                        <th>ID</th>
                        <th>Quote (£)</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% job.allQuotes.forEach(q => { %>
                        <tr class="<%= q.isSelected ? 'highlight-selected' : q.isMine ? 'highlight-mine' : '' %>">
                          <td><%= q.bodyshopName %></td>
                          <td><%= q.bodyshopId %></td>
                          <td>£<%= q.price %></td>
                          <td>
                            <% if (q.isSelected) { %>
                              <span class="badge badge-allocated">Selected</span>
                            <% } else if (q.isMine) { %>
                              <span class="badge badge-info">Your Quote</span>
                            <% } else { %>
                              —
                            <% } %>
                          </td>
                        </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              </div>
            <% }) %>
          <% } %>
        </section>
        
        
      <% } %>
      

  </div> 

</div> 

<script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    // ✅ Alert auto-remove
    const alertBox = document.querySelector('.alert.success');
    if (alertBox) {
      setTimeout(() => alertBox.remove(), 5000);
    }

    // ✅ Lightbox for all image previews
    const lightbox = GLightbox({ selector: '.glightbox' });

    // ✅ Expand/collapse for unselected jobs
    const summaryHeaders = document.querySelectorAll('.summary-header');
    summaryHeaders.forEach(header => {
      header.addEventListener('click', () => {
        const content = header.nextElementSibling;
        if (content) {
          content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }
      });
    });
  });
</script>
<script src="/js/bodyshop-quote-submit.js"></script>


</body>
</html>